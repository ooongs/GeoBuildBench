You are solving a geometry problem. Follow the ReAct (Reasoning and Acting) pattern to iteratively improve your solution.

## Problem:
{problem_text}

## Your Goal:
Generate DSL code that creates a geometric construction matching the problem description.

**Note**: DSL syntax and commands are provided in the system prompt. Refer to it for command reference, mathematical expressions, and critical rules.

## ReAct Workflow:

1. **Thought** - Analyze the problem and plan your approach
2. **Action** - Choose: `generate_dsl`, `modify_dsl`, or `final_answer`
3. **Observation** - Review execution results (image + errors + validation)
4. **Reflect** - Learn from what worked or failed
5. **Iterate** - Repeat until successful

## Output Format:

ALWAYS structure your response EXACTLY like this:

**Thought:** [Your reasoning - what do you need to do next and why?]

**Action:** [choose: generate_dsl, modify_dsl, or final_answer]

[If generate_dsl or modify_dsl, provide DSL code:]
```
[Complete DSL code here]
```

[If final_answer:]
The construction is complete. The DSL successfully creates [describe what was created].

## Error Analysis Process

When you receive an error, follow this systematic process:

### 1. Read the Error Message

Extract these key pieces:
- **Line number**: Where the error occurred
- **Error type**: KeyError, ValueError, AssertionError, etc.
- **Specific cause**: What went wrong
- **Hints**: Suggestions from the system

**Common Error Types:**
- **UNDEFINED ELEMENT** (KeyError) - You used an element before defining it
- **DUPLICATE LABEL** (ValueError) - You tried to redefine an existing element
- **UNKNOWN COMMAND** (KeyError) - Wrong command name or input types
- **OUTPUT COUNT MISMATCH** (AssertionError) - Command returned wrong number of outputs
- **MISSING ARROW** (ValueError) - Forgot `->` in command syntax

### 2. Observe the Rendered Image (CRITICAL)

If an image is provided, analyze it BEFORE modifying your DSL:

**What to check:**
1. Are all required points visible and correctly positioned?
2. Are all required segments/lines present?
3. Are circles drawn with correct centers and radii?
4. Does the overall shape match the problem requirements?

**Example analysis:**
```
Thought: Looking at the rendered image, I can see:
- Points A, B, C form a triangle ✓
- Segments AB and BC are drawn ✓
- BUT segment CA is missing ✗
- Point D should be on segment AB but appears elsewhere ✗

The error message confirms: line 8 has "UNDEFINED ELEMENT: 'D'".
Looking at my DSL, I used D before defining it.

Fix: Define point D on segment AB (before line 8), then add segment CA.

Action: modify_dsl
```

### 3. Choose Your Fix Strategy

**Strategy A - Specific Fix** (for small, isolated errors):
- Single undefined element
- One missing segment
- Simple syntax error

**Strategy B - Major Revision** (for fundamental issues):
- Wrong overall approach
- Multiple cascading errors
- Misunderstood the problem

**Strategy C - Incremental Addition** (when close to solution):
- Construction is 90% correct
- Just missing one or two elements
- Validation score is high but not passing

### 4. Learn from Previous Attempts

**Track your progress:**
- If same error repeats → Change your approach
- If different errors appear → You're making progress
- If image looks closer → You're on the right track

**Avoid repeating mistakes:**
- ❌ Don't try the exact same DSL code again
- ❌ Don't use the forbidden `polygon` command
- ❌ Don't use undefined elements
- ✅ Make specific, targeted changes based on error
- ✅ Use hints from error messages
- ✅ Reference the image to understand what actually got constructed

## Validation Understanding

Your construction is scored on two dimensions:

**Object Score (30%)**: Percentage of required objects found
- Points, segments, circles, lines must be explicitly created
- Segments can be inferred if both endpoints exist, but safer to create explicitly

**Condition Score (70%)**: Percentage of geometric conditions satisfied
- Angles, parallelism, perpendicularity, distances, etc.
- These must be satisfied through careful construction

**Passing threshold**: Both scores must be ≥90%

**Validation-friendly construction:**
1. Create ALL mentioned objects explicitly
2. Use meaningful labels matching the problem (e.g., `triangle`, `line_BC`)
3. For triangles/polygons, create each segment individually (NO `polygon` command!)
4. Position points carefully to satisfy geometric constraints

## Previous Attempts:

{history}

## Learning from History:

Review the history above carefully:
- Which approaches succeeded and which failed?
- What were the root causes of errors (syntax, logic, missing objects)?
- Have you made the same mistake multiple times?
- Are rendered images showing progress toward the solution?
- What patterns can you identify in the error messages?

**If you see repeated failures:**
- Try a completely different construction approach
- Re-read the problem statement carefully
- Focus on what the image shows vs. what's required
- Break down the problem into smaller steps

## Key Principles:

- **Use the image as your primary feedback** - It shows exactly what your DSL created
- **Pay attention to error messages** - They tell you exactly what went wrong
- **Learn from validation scores** - Check which conditions failed
- **Iterate systematically** - Don't make random changes, have a clear reason for each modification
- **Define before use** - Check your DSL for proper ordering
- **Create explicit segments** - Never use the `polygon` command

Now continue with your next step:
